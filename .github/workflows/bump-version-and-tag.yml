name: Bump Version, Tag, and Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: Version string (e.g. 1.2.3)
        required: true

jobs:
  bump-tag-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get previous tag
        id: previous_tag
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          echo "tag=${PREV_TAG}" >> $GITHUB_OUTPUT
          echo "Previous tag: ${PREV_TAG}"

      - name: Generate changelog using GitHub API
        id: changelog
        uses: actions/github-script@v7
        with:
          script: |
            const previousTag = '${{ steps.previous_tag.outputs.tag }}';
            const newVersion = '${{ github.event.inputs.version }}';
            
            // If no previous tag exists, get all PRs
            let releaseNotes = {};
            
            if (previousTag) {
              try {
                releaseNotes = await github.rest.repos.generateReleaseNotes({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  tag_name: newVersion,
                  previous_tag_name: previousTag
                });
              } catch (error) {
                console.log('Could not generate release notes via API, falling back to manual generation');
                releaseNotes.data = { body: '' };
              }
            }
            
            // Get merged PRs since last tag
            const prQuery = previousTag 
              ? `repo:${context.repo.owner}/${context.repo.repo} is:pr is:merged merged:>=${previousTag}`
              : `repo:${context.repo.owner}/${context.repo.repo} is:pr is:merged`;
              
            const { data: pullRequests } = await github.rest.search.issuesAndPullRequests({
              q: prQuery,
              sort: 'updated',
              order: 'desc',
              per_page: 100
            });
            
            // Categorize PRs by label
            const enhancements = [];
            const bugs = [];
            const documentation = [];
            const other = [];
            const contributors = new Set();
            
            for (const pr of pullRequests.items) {
              const labels = pr.labels.map(l => l.name);
              contributors.add(pr.user.login);
              
              const prEntry = `- ${pr.title} (#${pr.number}) @${pr.user.login}`;
              
              if (labels.some(l => ['enhancement', 'feature', 'Type: Enhancement'].includes(l))) {
                enhancements.push(prEntry);
              } else if (labels.some(l => ['bug', 'fix', 'Type: Bug'].includes(l))) {
                bugs.push(prEntry);
              } else if (labels.some(l => ['documentation', 'docs'].includes(l))) {
                documentation.push(prEntry);
              } else if (!labels.includes('ignore-for-changelog')) {
                other.push(prEntry);
              }
            }
            
            // Export data for next step
            core.setOutput('enhancements', enhancements.join('\n'));
            core.setOutput('bugs', bugs.join('\n'));
            core.setOutput('documentation', documentation.join('\n'));
            core.setOutput('other', other.join('\n'));
            core.setOutput('contributors', Array.from(contributors).join(', '));
            core.setOutput('github_notes', releaseNotes.data?.body || '');
            core.setOutput('pr_count', pullRequests.items.length);

      - name: Create final changelog file
        run: |
          version="${{ github.event.inputs.version }}"
          version_no_prefix=$(echo $version | sed 's/^v//')
          changelog_path="assets/changelogs/$version_no_prefix.md"
          
          # Create directory if it doesn't exist
          mkdir -p assets/changelogs
          
          # Prepare Contributor List
          contributors="${{ steps.changelog.outputs.contributors }}"
          if [ -n "$contributors" ]; then
            contributor_mentions=$(echo "$contributors" | sed 's/,/, @/g' | sed 's/^/@/')
            thank_you_note="A huge thank you to ${contributor_mentions} for their contributions to this update! <3"
          else
            thank_you_note="Thank you to all contributors! <3"
          fi
          
          # Build changelog
          cat > "$changelog_path" << 'CHANGELOG_EOF'
          ## ðŸŒŸ Ankimon v$VERSION_NO_PREFIX ðŸŒŸ
          
          $THANK_YOU_NOTE
          
          ### What's new
          
          This release includes $PR_COUNT merged pull requests with enhancements, bug fixes, and improvements.
          
          ### ðŸ’¢ PSA
          If you love Ankimon, please join our developers ðŸ¥º
          **Dev Guide**: https://h0tp-ftw.github.io/ankimon/
          
          Feel free to study with us in the **Library VC** in our [Discord](https://discord.gg/Vkvdawxd5s)!
          
          â€” h0tp ðŸ’–
          
          ***
          
          ## ðŸ“œ Full changelog â€” v$VERSION_NO_PREFIX
          
          CHANGELOG_EOF
          
          # Add Features & Improvements
          if [ -n "${{ steps.changelog.outputs.enhancements }}" ]; then
            cat >> "$changelog_path" << 'EOF'
          ### âœ¨ Features & Improvements
          
          $ENHANCEMENTS
          
          EOF
          fi
          
          # Add Bug Fixes
          if [ -n "${{ steps.changelog.outputs.bugs }}" ]; then
            cat >> "$changelog_path" << 'EOF'
          ### ðŸ› Bug Fixes & Stability
          
          $BUGS
          
          EOF
          fi
          
          # Add Documentation
          if [ -n "${{ steps.changelog.outputs.documentation }}" ]; then
            cat >> "$changelog_path" << 'EOF'
          ### ðŸ“š Documentation
          
          $DOCUMENTATION
          
          EOF
          fi
          
          # Add Other changes
          if [ -n "${{ steps.changelog.outputs.other }}" ]; then
            cat >> "$changelog_path" << 'EOF'
          ### ðŸ”§ Other Changes
          
          $OTHER
          
          EOF
          fi
          
          cat >> "$changelog_path" << 'EOF'
          
          ***
          EOF
          
          # Replace placeholders
          sed -i "s/\$VERSION_NO_PREFIX/${version_no_prefix}/g" "$changelog_path"
          sed -i "s/\$THANK_YOU_NOTE/${thank_you_note}/g" "$changelog_path"
          sed -i "s/\$PR_COUNT/${{ steps.changelog.outputs.pr_count }}/g" "$changelog_path"
          
          # Use printf to handle multiline variables properly
          tmp_file=$(mktemp)
          cp "$changelog_path" "$tmp_file"
          
          # Replace enhancement section
          if [ -n "${{ steps.changelog.outputs.enhancements }}" ]; then
            awk -v enhancements="${{ steps.changelog.outputs.enhancements }}" \
              '{gsub(/\$ENHANCEMENTS/, enhancements); print}' "$tmp_file" > "$changelog_path"
            cp "$changelog_path" "$tmp_file"
          fi
          
          # Replace bugs section  
          if [ -n "${{ steps.changelog.outputs.bugs }}" ]; then
            awk -v bugs="${{ steps.changelog.outputs.bugs }}" \
              '{gsub(/\$BUGS/, bugs); print}' "$tmp_file" > "$changelog_path"
            cp "$changelog_path" "$tmp_file"
          fi
          
          # Replace documentation section
          if [ -n "${{ steps.changelog.outputs.documentation }}" ]; then
            awk -v docs="${{ steps.changelog.outputs.documentation }}" \
              '{gsub(/\$DOCUMENTATION/, docs); print}' "$tmp_file" > "$changelog_path"
            cp "$changelog_path" "$tmp_file"
          fi
          
          # Replace other section
          if [ -n "${{ steps.changelog.outputs.other }}" ]; then
            awk -v other="${{ steps.changelog.outputs.other }}" \
              '{gsub(/\$OTHER/, other); print}' "$tmp_file" > "$changelog_path"
            cp "$changelog_path" "$tmp_file"
          fi
          
          rm -f "$tmp_file"
          
          echo "Changelog created at: $changelog_path"
          cat "$changelog_path"

      - name: Bump version in manifest.json
        run: |
          version="${{ github.event.inputs.version }}"
          jq --arg ver "$version" '.version = $ver' src/Ankimon/manifest.json > tmp.json && mv tmp.json src/Ankimon/manifest.json
          echo "Updated manifest.json to version: $version"

      - name: Create Pull Request for version bump
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "Bump version to ${{ github.event.inputs.version }}"
          title: "ðŸš€ Bump version to ${{ github.event.inputs.version }}"
          body: |
            ## Version Bump to ${{ github.event.inputs.version }}
            
            This automated PR bumps the version and includes an auto-generated changelog.
            
            ### âœ… Checklist
            - [ ] Review the generated changelog in `assets/changelogs/`
            - [ ] Verify `manifest.json` version update
            - [ ] Merge this PR to main
            
            ---
            
            **Next Steps After Merge:**
            
            The tag `${{ github.event.inputs.version }}` will need to be created to trigger the release workflow.
            
            **Option 1: Automatic (Recommended)**
            Merge this PR and the workflow will handle tagging automatically.
            
            **Option 2: Manual**
            ```
            git fetch origin
            git checkout main
            git pull
            git tag ${{ github.event.inputs.version }}
            git push origin ${{ github.event.inputs.version }}
            ```
            
            **Generated Changelog Preview:**
            
            ${{ steps.changelog.outputs.pr_count }} pull requests included in this release.
          branch: bump-version-${{ github.event.inputs.version }}
          base: main
          labels: |
            release
            automated
          add-paths: |
            src/Ankimon/manifest.json
            assets/changelogs/
