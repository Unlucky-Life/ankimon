name: Bump Version, Tag, and Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: Version string (e.g. 1.2.3)
        required: true

jobs:
  bump-tag-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get previous tag
        id: previous_tag
        run: echo "tag=$(git describe --tags --abbrev=0)" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        uses: tj-actions/changelog-generator@v1.18
        with:
          from_tag: ${{ steps.previous_tag.outputs.tag }}
          labels: |
            - enhancement
            - bug
            - documentation
          exclude_labels: "ignore-for-changelog"
          exclude_authors: "github-actions[bot]"
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create final changelog file
        run: |
          version=${{ github.event.inputs.version }}
          version_no_prefix=$(echo $version | sed 's/^v//')
          changelog_path="assets/changelogs/$version_no_prefix.md"
          
          # Prepare Contributor List
          contributors=$(echo "${{ steps.changelog.outputs.contributors }}" | sed 's/,/, @/g' | sed 's/^/@/')
          thank_you_note="A huge thank you to ${contributors} for their contributions to this update! <3"
          
          # Prepare "What's New" from PR titles
          pr_titles=$(echo "${{ steps.changelog.outputs.pr_titles }}" | sed 's/^/- /')

          {
            echo "## ðŸŒŸ Ankimon v$version_no_prefix ðŸŒŸ"
            echo ""
            echo "$thank_you_note"
            echo ""
            echo "### Whatâ€™s new"
            echo "$pr_titles"
            echo ""
            echo "### ðŸ’¢ PSA"
            echo "If you love Ankimon, please join our developers ðŸ¥º"
            echo "**Dev Guide**: https://h0tp-ftw.github.io/ankimon/"
            echo ""
            echo "Feel free to study with us in the **Library VC** in our [Discord](https://discord.gg/Vkvdawxd5s)!"
            echo ""
            echo "â€” h0tp ðŸ’–"
            echo ""
            echo "***"
            echo ""
            echo "## ðŸ“œ Full changelog â€” v$version_no_prefix"
            echo ""
            echo "### Features & Improvements"
            echo "${{ steps.changelog.outputs.enhancement_contributions }}"
            echo ""
            echo "### Bug Fixes & Stability"
            echo "${{ steps.changelog.outputs.bug_contributions }}"
            echo ""
            echo "### Documentation"
            echo "${{ steps.changelog.outputs.documentation_contributions }}"
            echo ""
            echo "***"
          } > "$changelog_path"

      - name: Bump version in manifest.json
        run: |
          jq '.version = "${{ github.event.inputs.version }}"' src/Ankimon/manifest.json > tmp.json && mv tmp.json src/Ankimon/manifest.json

      - name: Create Pull Request for version bump
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "Bump version to ${{ github.event.inputs.version }}"
          title: "Bump version to ${{ github.event.inputs.version }}"
          body: |
            Automated PR to bump version to ${{ github.event.inputs.version }}.
            This PR includes the automatically generated changelog based on merged PRs. Please review before merging.

            ---
            **@h0tp-ftw: After merging this PR, create the tag and push it with:**

            ```
            git fetch origin
            git checkout main
            git pull
            git tag ${{ github.event.inputs.version }}
            git push origin ${{ github.event.inputs.version }}
            ```

            This will create and push the tag needed to trigger the release workflow.
          branch: bump-version-${{ github.event.inputs.version }}
          base: main
          add-paths: |
            src/Ankimon/manifest.json
            assets/changelogs/
