name: Bump Version, Tag, and Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: Version string (e.g. 1.2.3)
        required: true

jobs:
  bump-tag-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get previous tag
        id: previous_tag
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          echo "tag=${PREV_TAG}" >> $GITHUB_OUTPUT
          echo "Previous tag: ${PREV_TAG}"

      - name: Generate changelog using GitHub API
        id: changelog
        uses: actions/github-script@v7
        with:
          script: |
            const previousTag = '${{ steps.previous_tag.outputs.tag }}';
            const newVersion = '${{ github.event.inputs.version }}';
            
            console.log(`Generating changelog from ${previousTag} to ${newVersion}`);
            
            let pullRequests = [];
            const contributors = new Set();
            
            if (previousTag) {
              try {
                // Step 1: Use compare API to get commits between tags
                const comparison = await github.rest.repos.compareCommitsWithBasehead({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  basehead: `${previousTag}...HEAD`
                });
                
                console.log(`Found ${comparison.data.commits.length} commits between ${previousTag} and HEAD`);
                
                // Step 2: For each commit, get associated pull requests
                const prNumbers = new Set();
                
                for (const commit of comparison.data.commits) {
                  try {
                    const { data: prs } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      commit_sha: commit.sha
                    });
                    
                    // Add each PR number to our set (avoids duplicates)
                    for (const pr of prs) {
                      if (pr.merged_at && !prNumbers.has(pr.number)) {
                        prNumbers.add(pr.number);
                        pullRequests.push(pr);
                        if (pr.user && pr.user.login !== 'github-actions[bot]') {
                          contributors.add(pr.user.login);
                        }
                      }
                    }
                  } catch (error) {
                    console.log(`Could not fetch PRs for commit ${commit.sha}: ${error.message}`);
                  }
                }
                
                console.log(`Found ${pullRequests.length} unique PRs`);
                
              } catch (error) {
                console.log(`Error comparing commits: ${error.message}`);
                // Fallback: get recent merged PRs if comparison fails
                const { data: recentPRs } = await github.rest.pulls.list({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  state: 'closed',
                  sort: 'updated',
                  direction: 'desc',
                  per_page: 50
                });
                
                pullRequests = recentPRs.filter(pr => pr.merged_at);
                for (const pr of pullRequests) {
                  if (pr.user && pr.user.login !== 'github-actions[bot]') {
                    contributors.add(pr.user.login);
                  }
                }
              }
            } else {
              console.log('No previous tag found, fetching recent merged PRs');
              // No previous tag - get recent merged PRs
              const { data: recentPRs } = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'closed',
                sort: 'updated',
                direction: 'desc',
                per_page: 100
              });
              
              pullRequests = recentPRs.filter(pr => pr.merged_at);
              for (const pr of pullRequests) {
                if (pr.user && pr.user.login !== 'github-actions[bot]') {
                  contributors.add(pr.user.login);
                }
              }
            }
            
            // Categorize PRs by label
            const enhancements = [];
            const bugs = [];
            const documentation = [];
            const other = [];
            
            for (const pr of pullRequests) {
              const labels = pr.labels.map(l => l.name.toLowerCase());
              
              // Skip if marked to exclude from changelog
              if (labels.includes('ignore-for-changelog') || 
                  labels.includes('exclude-from-changelog') ||
                  labels.includes('meta: exclude from changelog')) {
                continue;
              }
              
              const prEntry = `- ${pr.title} (#${pr.number}) @${pr.user.login}`;
              
              if (labels.some(l => ['enhancement', 'feature', 'type: enhancement'].includes(l))) {
                enhancements.push(prEntry);
              } else if (labels.some(l => ['bug', 'fix', 'type: bug'].includes(l))) {
                bugs.push(prEntry);
              } else if (labels.some(l => ['documentation', 'docs', 'type: documentation'].includes(l))) {
                documentation.push(prEntry);
              } else {
                other.push(prEntry);
              }
            }
            
            // Export data for next step
            core.setOutput('enhancements', enhancements.join('\n'));
            core.setOutput('bugs', bugs.join('\n'));
            core.setOutput('documentation', documentation.join('\n'));
            core.setOutput('other', other.join('\n'));
            core.setOutput('contributors', Array.from(contributors).sort().join(', '));
            core.setOutput('pr_count', pullRequests.length);
            
            console.log('Changelog generation complete!');
            console.log(`- Total PRs: ${pullRequests.length}`);
            console.log(`- Enhancements: ${enhancements.length}`);
            console.log(`- Bugs: ${bugs.length}`);
            console.log(`- Documentation: ${documentation.length}`);
            console.log(`- Other: ${other.length}`);
            console.log(`- Contributors: ${Array.from(contributors).join(', ')}`);

      - name: Create final changelog file
        env:
          ENHANCEMENTS: ${{ steps.changelog.outputs.enhancements }}
          BUGS: ${{ steps.changelog.outputs.bugs }}
          DOCUMENTATION: ${{ steps.changelog.outputs.documentation }}
          OTHER: ${{ steps.changelog.outputs.other }}
          CONTRIBUTORS: ${{ steps.changelog.outputs.contributors }}
          PR_COUNT: ${{ steps.changelog.outputs.pr_count }}
        run: |
          version="${{ github.event.inputs.version }}"
          version_no_prefix=$(echo "$version" | sed 's/^v//')
          changelog_path="assets/changelogs/$version_no_prefix.md"
          
          # Create directory if it doesn't exist
          mkdir -p assets/changelogs
          
          # Prepare Contributor List
          if [ -n "$CONTRIBUTORS" ]; then
            contributor_mentions=$(echo "$CONTRIBUTORS" | sed 's/,/, @/g' | sed 's/^/@/')
            thank_you_note="A huge thank you to ${contributor_mentions} for their contributions to this update! <3"
          else
            thank_you_note="Thank you to all contributors! <3"
          fi
          
          # Create changelog using heredoc with proper quoting
          cat > "$changelog_path" << 'EOF'
          ## ðŸŒŸ Ankimon vVERSION_PLACEHOLDER ðŸŒŸ

          THANK_YOU_PLACEHOLDER

          ### What's new

          This release includes PR_COUNT_PLACEHOLDER merged pull requests with enhancements, bug fixes, and improvements.

          ### ðŸ’¢ PSA
          If you love Ankimon, please join our developers ðŸ¥º
          **Dev Guide**: https://h0tp-ftw.github.io/ankimon/

          Feel free to study with us in the **Library VC** in our [Discord](https://discord.gg/Vkvdawxd5s)!

          â€” h0tp ðŸ’–

          ***

          ## ðŸ“œ Full changelog â€” vVERSION_PLACEHOLDER

          EOF
          
          # Add Features & Improvements
          if [ -n "$ENHANCEMENTS" ]; then
            cat >> "$changelog_path" << 'EOF'
          ### âœ¨ Features & Improvements

          EOF
            # Use printf to safely add content
            printf '%s\n\n' "$ENHANCEMENTS" >> "$changelog_path"
          fi
          
          # Add Bug Fixes
          if [ -n "$BUGS" ]; then
            cat >> "$changelog_path" << 'EOF'
          ### ðŸ› Bug Fixes & Stability

          EOF
            printf '%s\n\n' "$BUGS" >> "$changelog_path"
          fi
          
          # Add Documentation
          if [ -n "$DOCUMENTATION" ]; then
            cat >> "$changelog_path" << 'EOF'
          ### ðŸ“š Documentation

          EOF
            printf '%s\n\n' "$DOCUMENTATION" >> "$changelog_path"
          fi
          
          # Add Other changes
          if [ -n "$OTHER" ]; then
            cat >> "$changelog_path" << 'EOF'
          ### ðŸ”§ Other Changes

          EOF
            printf '%s\n\n' "$OTHER" >> "$changelog_path"
          fi
          
          # Add closing
          cat >> "$changelog_path" << 'EOF'

          ***
          EOF
          
          # Replace placeholders using sed (safe because placeholders don't contain special chars)
          sed -i "s/VERSION_PLACEHOLDER/${version_no_prefix}/g" "$changelog_path"
          sed -i "s/THANK_YOU_PLACEHOLDER/${thank_you_note}/g" "$changelog_path"
          sed -i "s/PR_COUNT_PLACEHOLDER/${PR_COUNT}/g" "$changelog_path"
          
          echo "Changelog created at: $changelog_path"
          echo "----------------------------------------"
          cat "$changelog_path"

      - name: Bump version in manifest.json
        run: |
          version="${{ github.event.inputs.version }}"
          jq --arg ver "$version" '.version = $ver' src/Ankimon/manifest.json > tmp.json && mv tmp.json src/Ankimon/manifest.json
          echo "Updated manifest.json to version: $version"

      - name: Create Pull Request for version bump
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "Bump version to ${{ github.event.inputs.version }}"
          title: "ðŸš€ Bump version to ${{ github.event.inputs.version }}"
          body: |
            ## Version Bump to ${{ github.event.inputs.version }}
            
            This automated PR bumps the version and includes an auto-generated changelog.
            
            ### âœ… Pre-Merge Checklist
            - [ ] Review the generated changelog in `assets/changelogs/`
            - [ ] Verify `manifest.json` version update is correct
            - [ ] Check that all changes are intentional
            
            ---
            
            ### ðŸ“‹ Post-Merge Steps (REQUIRED)
            
            After you merge this PR, **you must manually create and push the tag** to trigger the release workflow:
            
            ```
            # 1. Update your local main branch
            git checkout main
            git pull origin main
            
            # 2. Create the tag
            git tag ${{ github.event.inputs.version }}
            
            # 3. Push the tag to trigger release workflow
            git push origin ${{ github.event.inputs.version }}
            ```
            
            **Why manual?** For security, only maintainers can create tags that trigger releases.
            
            ---
            
            ### ðŸ“Š Release Summary
            - **Version**: ${{ github.event.inputs.version }}
            - **PRs included**: ${{ steps.changelog.outputs.pr_count }}
            - **Contributors**: ${{ steps.changelog.outputs.contributors }}
          branch: bump-version-${{ github.event.inputs.version }}
          base: main
          labels: |
            release
            automated
          add-paths: |
            src/Ankimon/manifest.json
            assets/changelogs/
