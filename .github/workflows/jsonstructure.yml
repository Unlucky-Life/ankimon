name: Generate Folder JSON

on:
  push:
    branches:
      - main
  workflow_dispatch:  # allows manual triggering

jobs:
  generate-json:
    runs-on: ubuntu-latest

    steps:      
      # Step 1: Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: Set up Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      # Step 3: Install dependencies (if needed)
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # add any dependencies if your script needs them

      # Step 4: Run the folder-to-JSON script
      - name: Generate folder JSON
        run: python -c "
          import os, json
          addon_dir='ankimon/src/'
          json_file_structure='folder_structure.json'
          exclude_folders=['__pycache__']
          def folder_to_dict(path):
              if os.path.basename(path) in exclude_folders: return None
              d={'name':os.path.basename(path),'type':'folder','children':[]}
              try:
                  for i in os.listdir(path):
                      p=os.path.join(path,i)
                      d['children'].append(folder_to_dict(p) if os.path.isdir(p) else {'name':i,'type':'file'})
              except PermissionError:
                  d['children'].append({'name':'Permission Denied','type':'error'})
              return d
          structure=folder_to_dict(addon_dir) or {'name':'root','type':'folder','children':[]}
          json.dump(structure, open(json_file_structure,'w'), indent=4)
          "

      # Step 5: Upload the generated JSON as an artifact
      - name: Upload JSON
        uses: actions/upload-artifact@v4
        with:
          name: folder-structure
          path: folder_structure.json
